# Excel VBA KNN分類 & PCA可視化ツール

本ツールは、Excel VBAのみで実装された **k-近傍法 (k-Nearest Neighbors)** による分類および **主成分分析 (PCA)** による可視化プログラムです。
Python等の環境構築を必要とせず、ExcelとCSVファイルがあれば手軽に機械学習アルゴリズムとデータの可視化を試行できます。

## 特徴
- **環境構築不要**: ExcelがインストールされたWindows環境であれば即座に動作します。
- **汎用的なデータ対応**: 学習データとして外部CSVファイルを読み込みます（UTF-8対応）。
- **PCAによる可視化**: 高次元データを主成分分析で2次元に圧縮し、散布図としてアクティブシートに自動描画します。
- **分類結果のプロット**: ユーザーが入力したデータ（クエリ点）が、クラスターのどこに位置するかを赤丸で強調表示します。

## 構成ファイル
- `KNN.bas`: KNN分類のメインロジック、CSV読み込み、ユーザーインターフェース制御。
- `PCA_Graph.bas`: PCA（主成分分析）の計算、固有値分解（ヤコビ法）、Excelグラフ描画ロジック。

## 動作要件
1. **Microsoft Excel** (Windows版)
2. **学習用データ (CSVファイル)**
   - 文字コード: **UTF-8** (BOMあり/なし両対応)
   - 1行目にヘッダ（列名）が必要です。
   - **ターゲット列**: 分類したい正解ラベル（クラス名）を含む列。
   - **特徴量列**: ターゲット列以外の全ての列は、数値データである必要があります。

## 使用方法

### 1. モジュールのインポート
1. Excelを開き、`Alt` + `F11` キーでVBAエディタを開きます。
2. 「ファイル」>「ファイルのインポート」から `KNN.bas` と `PCA_Graph.bas` をそれぞれ読み込みます。

### 2. マクロの実行
1. Excelのシート画面に戻り、`Alt` + `F8` キーを押します。
2. マクロ一覧から `main_generic_knn_classify` を選択し、「実行」をクリックします。

### 3. パラメータの指定
実行後、以下の順で入力を求められます。

1. **学習データの選択**: ファイル選択ダイアログでCSVファイルを指定します。
2. **ターゲット列の指定**: 正解ラベルが格納されている列名を入力します（例: `species`）。
3. **特徴量の入力**: 分類したい未知のデータ（数値）をカンマ区切りで入力します。
   - 入力例: `6.4, 3.2, 4.5, 1.5`

### 4. 結果の確認
1. **分類結果**: 推論結果（予測されたクラス）と信頼度がメッセージボックスに表示されます。
2. **グラフ描画**: アクティブシートがクリアされ、PCAによって次元圧縮された散布図が作成されます。
   - **● (各色)**: 学習データの分布
   - **● (赤色)**: 入力したデータ（クエリ点）の位置

## アルゴリズムの概要

### k-近傍法 (KNN)
分類したいデータに対し、特徴空間上で距離が近い学習データを $k$ 個（デフォルト5個）抽出し、それらの多数決によってクラスを決定します。距離の逆数を用いた重み付けを行っています。

### 主成分分析 (PCA)
多次元の特徴量を、情報の損失を最小限に抑えつつ2次元（PC1, PC2）に圧縮します。
- **標準化**: KNNの距離計算と整合性を取るため、平均0・分散1に正規化して計算します。
- **ヤコビ法**: 対称行列の固有値分解をVBAで実装しています。
- **軸の調整**: 視認性を高めるため、主要なクラスがグラフの右側に来るよう軸の向きを自動調整します。

## 注意事項
- データ量が多い場合、VBAでの計算（特にPCAの行列演算）に時間がかかる可能性があります。
